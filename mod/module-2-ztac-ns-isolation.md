# Module 2 - Zero-Trust Workload Access Control with Namespace Isolation Recommendation

One of the best ways to make your Kubernetes cluster more secure is to use network policy to isolate namespaces. This means that you only allow the communication between namespaces that is absolutely necessary, and you block everything else. This helps to reduce the risk of an attacker moving from one part of your cluster to another if they manage to get in.

Calico Cloud makes it simple for platform operators to set up namespace isolation. You don't need to be an expert in writing network policies or know the details of how your applications communicate. Calico Cloud looks at the flow logs generated by your workloads. Then, it automatically suggests and sets up policies for each namespace. These policies can be used to isolate your namespaces from each other.

In this module, we will learn how to use Calico to recommend and set up network policies to control access to and from a namespace. We will install the `Cat Facts Application`. Once the application is deployed, we will enable the policy recommandations and then review and activate the policies.

1. Clone this repository in your Azure Cloud Shell.

   ```bash
   git clone https://github.com/tigera-solutions/cc-aks-zero-trust-workshop.git && \
   cd cc-aks-zero-trust-workshop
   ```

1. Install the example application stacks:

   From the cloned directory, execute:

   ```bash
   kubectl apply -f pre
   ```

Included in the `pre` folder, there is an application that will be used in the exercises during the workshop. The diagram below shows how the elements of this application communicate between themselves.

![catfacts-application](https://github.com/tigera-solutions/cc-aks-zero-trust-workshop/assets/104035488/868c7ccf-e215-41d6-91ab-635832700c50)

There are also other objects that will be created. We will learn about them later in the workshop.

> [!IMPORTANT]
> Wait until all the pods are up and running to move to the next step.

## Service Graph

Connect to Calico Cloud GUI. From the menu, select `Service Graph > Default`. Explore the options.

![service_graph](https://user-images.githubusercontent.com/104035488/192303379-efb43faa-1e71-41f2-9c54-c9b7f0538b34.gif)

## The Zero Trust approach

A global default deny policy ensures that unwanted traffic (ingress and egress) is denied by default. Pods without policy (or incorrect policy) are not allowed traffic until the appropriate network policy is defined. Although the staging policy tool will help you find the incorrect or the missing policy, a global deny policy helps mitigate other lateral malicious attacks.

By default, all traffic is allowed between the pods in a cluster. Let's start by testing connectivity between application components and across application stacks. All of these tests should succeed as there are no policies in place.

We recommend creating a global default deny policy after you complete reviewing the policy for the traffic you want to allow. Use the stage policy feature to get your allowed traffic working as expected, then lock down the cluster to block unwanted traffic.

## Enable policy recommendations

1. In the left navbar in Manager UI, click **Policies, Recommendations**.
2. On the opt-in page, click Enable Policy Recommendations.

   The Policy Recommendations board is automatically displayed.

   ![enable-policy-recommendation](https://github.com/tigera-solutions/cc-aks-zero-trust-workshop/assets/104035488/56a8a8b3-654d-40f8-9e04-160ff1439efd)

   > [!NOTE]
   >
   > - A policy recommendation is generated for every namespace in your cluster    (unless namespaces are filtered out by an Admin using the selector in the    PolicyRecommendationScope resource).
   > - Flow logs are continuously monitored for policy recommendations.
   > - Recommended policies are continuously updated until you Add to policy board    or Dismiss policy using the Actions menu.
   > - Policy recommendations are created as staged network policies so you can    safely observe the traffic before enforcing them.
   > - Traffic originating from the recommended policy's namespace is used to    generate egress rules, and traffic destined for the namespace is used to define    ingress rules.
   > - To stop policy recommendations from being processed and updated for a    namespace, click the Action menu, Dismiss policy.

3. Activate and review policy recommendations
  
   Policy recommendations are not enabled until you activate them and move them to the Active board.

   From the Policy Recommendation board, select a policy recommendation (or bulk select) and select, Add to policy board. Click on the Active tab.

   You can now view the activated policies in the Policies Board. In the left navbar, click Policies.

   Policy recommendations are added to the namespace-isolation tier. Note the following:

   - Staged network policy recommendations work like any other staged network policy.
   - You cannot move recommended staged policies in the namespace-isolation tier.
   - The name of the namespace-isolation tier is fixed and cannot be changed

   You are now ready to observe traffic flows in Policies board to verify that the policy is authorizing traffic as expected. When a policy works as expected, you can safely enforce it.










1. Create a staged global default-deny policy. It will show all the traffic that would be blocked if it were enforced.

   - Go to the `Policies Board`
   - On the bottom of the tier box `default` click on `Add Policy`
     - In the `Create Policy` page enter the policy name: `default-deny`
     - On the `Applies To` session, click `Add Namespace Seletor`
       First, lets apply only to the `vote` namespace
       - Select Key... `kubernetes.io/metadata.name`
       - =
       - Select Value... `vote`
     - On the field `Type` select both checkboxes: Ingress and Egress.
     - You are done. Click `Stage` on the top-right of your page.

   The staged policy does not affect the traffic directly but allows you to view the policy impact if it were to be enforced. You can see the denied traffic in the staged policy.

2. Based on the application design, the `db` lists on port `5432` and receive connections from the `worker` and the `result` microservices.
   Let's use the Calico Cloud UI to create a policy to microsegment this traffic.

   - Go to the `Policies Board`
   - On the bottom of the tier box `platform` click on `Add Policy`
     - In the `Create Policy` page enter the policy name: `db`
     - Change the `Scope` from `Global` to `Namespace` and select the namespace `vote`
     - On the `Applies To` session, click `Add Label Seletor`
       - Select Key... `app`
       - =
       - Select Value... `db`
       - Click on `SAVE LABEL SELECTOR`
     - On the field `Type` select the checkbox for Ingress.
     - Click on `Add Ingress Rule`
       - On the `Create New Policy Rule` window,
         - Click on the `dropdown` with `Any Protocol`
         - Change the radio button to `Protocol is` and select `TCP`
         - In the field `To:` click on `Add Port`
         - `Port is` 5432 - Save
         - In the field `From:`, click `Add Label Seletor`
           - Select Key... `app`
           - =
           - Select Value... `worker`
           - Click on `SAVE LABEL SELECTOR`  
           - On `OR`, click `Add Label Seletor`
           - Select Key... `app`
           - =
           - Select Value... `result`
           - Click on `SAVE LABEL SELECTOR`
         - Click on the button `Save Rule`
     - You are done. Click `Enforce` on the top-right of your page.

3. Now that you learned how to create policies using Calico Cloud UI, go ahead and create microsegmentation policies for all other workloads in the application.

4. If you create all the policies correctly, at some point, you will start seeing zero traffic being denied by your default-deny staged policy. At that point, you can go ahead and enforce the default-deny policy. Voilà! The vote namespace is now secure.

### Bonus - About Tiers

Tiers are a hierarchical construct used to group policies and enforce higher precedence policies that other teams cannot circumvent, providing the basis for **Identity-aware micro-segmentation**.

All Calico and Kubernetes security policies reside in tiers. You can start “thinking in tiers” by grouping your teams and the types of policies within each group, such as security, platform, etc.

Policies are processed in sequential order from top to bottom.

![policy-processing](https://user-images.githubusercontent.com/104035488/206433417-0d186664-1514-41cc-80d2-17ed0d20a2f4.png)

Two mechanisms drive how traffic is processed across tiered policies:

- Labels and selectors
- Policy action rules

For more information about tiers, please refer to the Calico Cloud documentation [Understanding policy tiers](https://docs.calicocloud.io/get-started/tutorials/policy-tiers)

---

[:arrow_right: Module 3 - Workload Isolation with Microsegmentation](/mod/module-3-wkload-isolation.md)   <br>

[:arrow_left: Module 1 - Connect the AKS cluster to Calico Cloud](/mod/module-1-connect-calicocloud.md)  
[:leftwards_arrow_with_hook: Back to Main](/README.md)  
